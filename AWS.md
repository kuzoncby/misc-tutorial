# Deploy Laravel with nginx, php-fpm, let's encrypt and jenkins on EC2### BaseUpdate your system```shyum update```Install those packages``` shyum install bash-completion vim wget git epel-release``` ## PHP-FPMInstall PHP 7.1 and composer```shyum install http://rpms.remirepo.net/enterprise/remi-release-7.rpmyum-config-manager --enable remi-php71yum install composer php php-fpm php-mysqlnd```Edit `/etc/php-fpm.d/www.conf````shlisten = /var/run/php-fpm/php-fpm.socklisten.owner = nginxlisten.group = nginxlisten.mode = 0660file_uploads = onupload_max_filesize = 100M post_max_size = 100Mmemory_limit = 128Mupload_tmp_dir = /tmp```## Let's EncryptConfig SSL with Let's Encrypt```shyum install certbot nginxvim /etc/nginx/default.d/le-well-known.confnginx -tsystemctl restart nginxcertbot certonly -a webroot --webroot-path=/usr/share/nginx/html -d example.com -d www.example.com -d api.example.comopenssl dhparam -out /etc/ssl/certs/dhparam.pem 2048```## JenkinsInstall Jenkins```shsudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.reposudo rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.keysudo yum install jenkins java-1.8.0-openjdk-devel```Create a directory under `/var/lib/jenkins`, like `/var/lib/jenkins/ssl````shmkdir /var/lib/jenkins/sslcd /var/lib/jenkins/sslcp /etc/letsencrypt/live/example.com/fullchain.pem /var/lib/jenkins/ssl/openssl rsa -in /etc/letsencrypt/live/example.com/privkey.pem -out privkey-rsa.pem```Edit Jenkins launch file: `/etc/sysconfig/jenkins````shJENKINS_PORT="-1"JENKINS_HTTPS_PORT="8443"JENKINS_ARGS="--httpsCertificate=/var/lib/jenkins/ssl/fullchain.pem --httpsPrivateKey=/var/lib/jenkins/ssl/privkey-rsa.pem"```Start Jenkins```shsystemctl start jenkins```# nginxEdit `/etc/nginx/conf.d/food.conf````server {	listen 443 http2 ssl;	server_name example.com www.example.com api.example.com;	ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;	ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;	ssl_prefer_server_ciphers on;	ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";	ssl_ecdh_curve secp384r1;	ssl_session_cache shared:SSL:10m;	ssl_session_tickets off;	ssl_stapling on;	ssl_stapling_verify on;	resolver 8.8.8.8 8.8.4.4 valid=300s;	resolver_timeout 5s;	add_header Strict-Transport-Security "max-age=63072000; includeSubdomains";	add_header X-Frame-Options DENY;	add_header X-Content-Type-Options nosniff;	ssl_dhparam /etc/ssl/certs/dhparam.pem;	location ~ /.well-known {		allow all;	}		root /var/lib/jenkins/workspace/food/public;	index index.php index.html index.htm;	location / {		try_files $uri $uri/ /index.php?$query_string;	}	location ~ \.php$ {		try_files $uri /index.php =404;		fastcgi_split_path_info ^(.+\.php)(/.+)$;		fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;		fastcgi_index index.php;		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;		include fastcgi_params;	}}```Enable GZip and upload limit in `/etc/nginx/nginx.conf````gzip            on;gzip_min_length 1000;gzip_proxied    expired no-cache no-store private auth;gzip_types      text/plain application/x-javascript text/css application/xml application/json text/javascript application/x-httpd-php image/jpeg image/gif image/png;client_max_body_size 2M;```Enable SSL redirect in `/etc/nginx/default.d/ssl-redirect.conf````return 301 https://$host$request_uri;```## SELinuxIf your laravel application cannot connect to redis server```shsetsebool httpd_can_network_connect=1```